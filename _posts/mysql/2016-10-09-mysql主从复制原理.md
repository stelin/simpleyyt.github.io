---
layout: post
title:  "mysql主从复制原理"
date:   2016-10-09
categories: [mysql]
---


# mysql主从复制原理

## 1. 主从复制是(异步)
    
主节点和从节点之间的数据是有延迟的，下面是主从复制结构图
![image](http://hi.csdn.net/attachment/201202/28/0_1330439010P7lI.gif)

- master把写操作的信息写入到binary log当中
- salve中有两个进程复制，IO thread 负责读取master的binary log写入到relay log,SQL thread读取relay log日志重放日志操作
- 影响主从复制的速度，IO进程的读取速度，SQL重放日志文件速度
- master多个进程写操作，写成功后写入到日志文件，但是IO进程是单进程读取master日志，所有这样会导致主从延迟。解决办法可以master写或假一致性（写操作后立即读取主）

## 2. binlog存储格式
复制是基于binlog日志，目前有三种存储格式

- statement:只记录SQL语句，存储量小，会导致数据不一致
- Row:存储event数据，存储日志量大，但不能直接进行读取
- Mixed:介于上面两种之间，建议使用此类型

## 3. 复制作用范围
可以对整个实例进行复制，也可对实例中的某个库或某个表进行复制

```python
// 通常master保持完整的操作，slave端做某个库或某个表复制的过滤，不影响数据同步的完整性
Mater                      Slave
--binlog-do-db             --replicate-do-db
--binlog-ingore-db         --repliacate-ingore-db

```

## 4. 复制类型

- 基于二进制的复制（5.5以前的）      
当master主从切换的时候就要，找到一个最新slave节点，但是slave节点是否最新的二进制文件，这就需要维护，
- 基于GTID基于事务的复制
解决上面的问题5.6以后推出事务复制。每一个master提交的事务都会有个全局唯一标示（主机标识符+操作ID）,当从节点重放这些事务，就可以知道哪些事务执行过。

## 5. 支持半同步复制
从本质上是异步复制，master和slave安装工具可以实现。master提交操作过后，等待其中一个slave写入磁盘成功后的返回信息，才执行下一个提交操作。

* 目录
{:toc #cntNav}



