---
title: 'Redis数据结构之动态字符串(一)'
layout: post
tags:
  - redis
  - 缓存
  - 数据存储
  - redis原理
category: 数据存储
---

redis里面的字符串，没有使用C语言的字符串，而是使用自己构建的简单动态字符串（SDS）。redis里面只把C字符串当做不修改的变量使用。

redis键值对，存储分为两部分:键值对的键和键值对的值；键值对的键是一个字符串对象，对象的底层是一个保存字符串的SDS对象，键值对的值也是一个对象（字符串对象、列表对象、哈希对象）

<!--more-->

# SDS定义

sds结构定义，/src/sds.h文件

```python
struct sdshdr {
// 记录buf中已经使用的字节数量
unsigned int len;
// 记录buf中未使用的字节数量
unsigned int free;
// 字节数组，用户保存字符串（C语言字符串）
char buf[];
};
```

* [ ] free值为0，没有任何分配的空间可以使用
* [ ] len 目前字符串长度
* [ ] buf 遵循C语言，最后一个字节保存空字符“\0”,空字符不计算长度，这样可以直接使用C语言的字符串函数，处理字符串。C语言字符串长度是n+1，即空字符串也算了长度的。

# ![](/assets/img/redis/2017-01-18-1.png)

# SDS优点

### 1. 字符串长度

C语言计算一个字符串长度，逐个循环字符串累加，时间复杂度O\(N\)。SDS直接获取len，时间复杂度O\(1\)，不会造成任何性能影响。

### 2. 杜绝缓存区溢出

C语言中，比如一个字符串值“redis”，现在需要将其修改为“redis server”，如果操作前，不对改字符串重新分配内存空间，将会导致内存溢出。

SDS字符串修改的时，先获取free空间，计算是否需要扩展内存空间。如果不满足，则需要重新分配内存空间后，执行修改字符串操作。

### 3. 减少字符串内存分配次数

C字符串每次修改的时候，都需要重新分配内存空间。内存分配需要复杂的算法，以及调用系统函数，通常是一个比较消耗时间的操作。

##### 预分配策略

SDS修改后，SDS长度将小于1MB。程序也将给free分配大小等于1MB空间。此时SDS中，free=len两个相同。如果SDS修改后的长度大于1MB，那么预分配的空间将是30M。通过预分配策略可以减少预分配空间次数。

##### 惰性释放空间

惰性释放空间，用于SDS缩短操作。当SDS字符串缩短后，程序不是立即回收空间，而是保持在free里面等待使用。

### 4. 二进制安全

C字符串不能包含空字符，否则最先读的空字符，将以为是字符串尾部。SDS使用len表示字符串是否读取到末尾，而不是根据空字符串判断。所有SDS可以保存任何字符串。

### 5. 兼容C函数

SDS不仅支持二进制安全，还可以使用C字符串函数处理，因为SDS也是以控制符结尾的。




