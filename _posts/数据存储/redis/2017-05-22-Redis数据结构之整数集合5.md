---
title: 'Redis数据结构之整数集合(五)'
layout: post
tags:
  - redis
  - 缓存
  - 数据存储
  - redis原理
category: 数据存储
---


整数集合是集合键的底层实现之一，当一个集合只包含整数元素，b并且这个集合元素不多，就会使用整数集合作为集合底层实现。

<!--more-->

## 整数集合实现

实现在intset.h/intset结构里面。保存的整数类型，有int\_16 int\_32 int\_64

```python
typedef struct intset {
// 编码方式
uint32_t encoding;
// 集合包含元素的数量
uint32_t length;
// 保存元素的数组，从小到大的顺序，不重复
int8_t contents[];
} intset;
```

![](/assets/img/redis/2017-01-18-6-1.png)

![](/assets/img/redis/2017-01-18-6-2.png)

## 升级

每当添加一个新的元素到整数集合里面，新添加的元素比所有元素类型都要长，此时整数集合需要升级，然后才能添加新的元素到整数集合。升级的好处是提升整数集合的灵活性和节省内存。

> 升级步骤
>
> 根据新的元素类型，扩展整数集合底层数组空间大小，并为新元素分配空间。
>
> 将整数集合底层现有所有元素，转成新元素同类型，并将其转换后的类型放到正确的位置，放置过程中需要保持底层数组顺序不变
>
> 将新的元素添加的底层数组里面

## 降级

整数集合不支持降级操作，一旦升级，编码就会一直保持这个状态，直到再次升级




